syntax = "proto3";
package backup;
option go_package = "github.com/cloudogu/ces-control-api/generated/backup";

// The Backup service provides endpoints to retrieve information about backups.
service BackupManagement {
  // LastSuccessful retrieves information about the last successfully created backup.
  rpc LastSuccessful(LastSuccessfulBackupRequest) returns (BackupResponse);
  // ResticCredValid retrieves information about the validity of the restic credentials from etcd
  rpc ResticCredValid(ResticCredentialValidRequest) returns (ResticCredentialResponse);
  // GetSchedule retrieves the backup schedule as a cron expression.
  rpc GetSchedule(GetBackupScheduleRequest) returns (GetBackupScheduleResponse);
  // SetSchedule sets the backup schedule as a cron expression.
  rpc SetSchedule(SetBackupScheduleRequest) returns (SetBackupScheduleResponse);
  // GetRetentionPolicy retrieves the current backup retention policy.
  rpc GetRetentionPolicy(RetentionPolicyRequest) returns (RetentionPolicyResponse);
}

// LastSuccessfulBackupRequest contains the data which are used to retrieve information about the last successfully
// created backup.
message LastSuccessfulBackupRequest {
}

// LastBackupResponse contains information about the last successfully created backup.
message BackupResponse {
  // id contains the id of the backup.
  string id = 1;
  // start_time contains the time when the backup was started.
  string start_time = 2;
  // end_time contains the time when the backup process has ended.
  string end_time = 3;
  // type provides information about the backup type.
  string type = 4;
  // success indicates if the backup was successful.
  bool success = 5;
  // error_message contains a possible reason if the backup was not successful.
  string error_message = 6;
}

// ResticCredentialValidRequest contains the data which are used to retrieve information about validity of the restic
// repo credentials entered into etcd.
message ResticCredentialValidRequest {
}

// ResticCredentialResponse contains information about the validity of the restic credentials from etcd.
message ResticCredentialResponse {
  // valid indicates if the restic credentials from etcd are correct
  bool valid = 1;
}

// BackupScheduleRequest contains the data which are used to retrieve the backup schedule.
message GetBackupScheduleRequest {
}

// BackupScheduleResponse contains the backup schedule as a cron expression.
message GetBackupScheduleResponse {
  // schedule contains the backup schedule as a cron expression string.
  string schedule = 1;
}

// SetBackupScheduleRequest contains the data which are used to set the backup schedule.
message SetBackupScheduleRequest {
  // schedule contains the backup schedule as a cron expression string to be set.
  string schedule = 1;
}

// SetBackupScheduleResponse contains the result of setting the backup schedule.
message SetBackupScheduleResponse {
}

// RetentionPolicy defines the available backup retention policies.
enum RetentionPolicy {
  // KeepAll keeps all backups.
  KeepAll = 0;
  // RemoveAllButKeepLatest removes all backups but keeps the latest one.
  RemoveAllButKeepLatest = 1;
  // KeepLastSevenDays keeps backups from the last seven days.
  KeepLastSevenDays = 2;
  // KeepLast7DaysOldestOf1Month1Quarter1HalfYear1Year keeps backups from the last 7 days and the oldest backup of the last month, quarter, half year, and year.
  KeepLast7DaysOldestOf1Month1Quarter1HalfYear1Year = 3;
}

// RetentionPolicyRequest contains the data which are used to retrieve the retention policy.
message RetentionPolicyRequest {
}

// RetentionPolicyResponse contains the current backup retention policy.
message RetentionPolicyResponse {
  // policy contains the current retention policy.
  RetentionPolicy policy = 1;
}
